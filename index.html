<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Global Biotic Interactions</title>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css"/>
    <link rel="stylesheet" href="globi.css"/>
    <script src="https://rawgit.com/jhpoelen/eol-globi-data-js/master/globi-data-dist.js"></script>
    <script src="menu.js"></script>
    <script src="query-string.js"></script>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
    <script>
        $(function () {
            var labelForTaxon = function (taxon) {
                var englishName;
                if (taxon.commonNames) {
                    englishName = taxon.commonNames['en'];
                }
                var suggestion = taxon.scientificName;
                if (englishName !== undefined) {
                    suggestion = englishName + ' (' + suggestion + ')';
                }
                return suggestion;
            };

            var className = function (someString) {
                return someString.replace(/\W/g, '_');
            }

            var searchForInteractions = function () {
                var sourceTaxonName = globiData.currentSelection.value;
                var sourceTaxonLabel = globiData.currentSelection.label;
                var interactionType = $('#interactionType :selected').val()
                document.location.hash = queryString.stringify({ sourceTaxon: sourceTaxonName, interactionType: interactionType })

                var search = {sourceTaxonScientificName: sourceTaxonName, interactionType: interactionType };
                var callback = function (interactions) {
                    var resultDiv = document.getElementById('result');
                    $('.interaction').remove();
                    var distinctNames = {};
                    var counter = 0;
                    interactions.forEach(function (interaction) {
                        if (distinctNames[interaction.target.name] !== interaction.target.name) {
                            if (counter % 4 == 0) {
                                row = document.createElement('tr');
                                row.setAttribute('class', 'interaction');
                                resultDiv.appendChild(row);
                            }

                            var td = document.createElement('td');
                            td.setAttribute('class', className(interaction.target.name));
                            td.innerHTML = interaction.target.name;
                            row.appendChild(td);
                            distinctNames[interaction.target.name] = interaction.target.name;
                            counter += 1;
                        }
                    });
                    var textElem = document.createElement('p')
                    textElem.setAttribute('class', 'interaction');
                    var prefix = '<span class="' + sourceTaxonName + '">' + sourceTaxonLabel + '</span> ' + $('#interactionType :selected').text();
                    var message = textElem.innerHTML = '... plenty of things!';
                    if (counter == 0) {
                        message = '... nothing that we know of.';
                    }

                    textElem.innerHTML = prefix + message + ' Missing some results? Please <a href="https://github.com/jhpoelen/eol-globi-data/wiki/How-to-Contribute-Data-to-Global-Biotic-Interactions%3F">share your datasets</a>! Have suggestions? <a href="https://github.com/jhpoelen/eol-globi-data/issues/new"> Let us know</a>.';
                    document.getElementById('info').appendChild(textElem);

                    Object.keys(distinctNames).forEach(function (name) {
                        globiData.findTaxonInfo(name, function (taxonInfo) {
                            var label = name;
                            if (taxonInfo.scientificName) {
                                label = taxonInfo.scientificName;
                            }
                            if (taxonInfo.commonName !== null) {
                                label = taxonInfo.commonName + '<br>(' + label + ')';
                            }
                            var label = '<td>' + label + '</td>';
                            if (taxonInfo.infoURL) {
                                var link = '<a href="' + taxonInfo.infoURL + '"><table><tr><td>';
                                var image = '';
                                if (taxonInfo.thumbnailURL) {
                                    image = '<img src="' + taxonInfo.thumbnailURL + '"/>';
                                }
                                label = link + image + '</td></tr><caption align="bottom">' + label + '</caption></table></a>';
                            }
                            $('.' + className(name)).html(label);
                        });
                    });

                };
                globiData.findSpeciesInteractions(search, callback);
            };

            $(".suggest").autocomplete({
                minLength: 3,
                source: function (request, response) {
                    globiData.findCloseTaxonMatches(request.term, function (closeMatches) {
                        var suggestions = [];
                        closeMatches.forEach(function (closeMatch, index) {
                            suggestions[index] = {
                                label: labelForTaxon(closeMatch),
                                value: closeMatch.scientificName
                            };
                        });
                        response(suggestions);
                    });
                },
                select: function (event, ui) {
                    globiData.currentSelection = { value: ui.item.value, label: ui.item.label };
                    searchForInteractions();
                }
            });

            $("#PredatorNameInputField").change(function (event, ui) {
                searchForInteractions();
            });

            $("#interactionType").change(function (event, ui) {
                searchForInteractions();
            });
        });

        var init = function () {
            var params = queryString.parse(document.location.hash);
            if (params.sourceTaxon) {
                globiData.currentSelection = { value: params.sourceTaxon, label: params.sourceTaxon, interactionType: params.interactionType };
                $('#interactionType option[value="' + params.interactionType + '"]').prop('selected', 'selected');
                $('#PredatorNameInputField').val(params.sourceTaxon).change();
            }
            $('#PredatorNameInputField').focus();
            buildMenu();
        }
    </script>
</head>
<body onload="init()">
<div class="ui-widget">
    <p>What do
        <input id="PredatorNameInputField" class="suggest" autocomplete="off" placeholder="name of organism"/>
        <select id="interactionType">
            <option value="preysOn">eat</option>
            <option value="preyedUponBy">get eaten by</option>
            <option value="parasiteOf">parasitize</option>
            <option value="hasParasite">get parasitized by</option>
            <option value="pollinates">pollinate</option>
            <option value="pollinatedBy">get pollinated by</option>
            <option value="pathogenOf">infect</option>
            <option value="hasPathogen">get infected by</option>
            <option value="interactsWith">interact with</option>
        </select>?
    </p>
    <div id="info"></div>
    <table id="result">
    </table>
</div>
</body>
</html>
